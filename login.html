<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login — Bradesco Digital</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-app">
  <canvas id="bgParticles"></canvas>
  <a class="corner-logo" href="index.html" aria-label="Voltar para a página inicial">
    <img src="img/logo.png" alt="Bradesco">
  </a>

  <div class="center-area">
    <section class="card auth-card" role="form" aria-label="Formulário de Login">
      <h2>Entrar na sua conta</h2>
      <div id="loginAlert" class="alert" role="alert"></div>
      <form id="loginForm" class="form" autocomplete="on">
        <label class="field">
          <span>Usuário (E-mail ou CPF)</span>
          <input type="text" id="username" class="cpf-input" placeholder="seuemail@exemplo.com ou 000.000.000-00" required autocomplete="username">
        </label>
        <label class="field">
          <span>Senha</span>
          <input type="password" id="password" placeholder="••••••••" required autocomplete="current-password">
        </label>
        <button type="submit" class="btn btn-primary full" id="loginBtn">Entrar</button>
      </form>
      <p class="muted">Ainda não tem conta? <a href="cadastro.html">Cadastre-se</a></p>
    </section>
  </div>

  <script src="cpf.js"></script>
  <script src="api.js"></script>
  <script src="anim.js"></script>
  <script>
    const loginForm = document.getElementById('loginForm');
    const loginBtn = document.getElementById('loginBtn');
    const loginAlert = document.getElementById('loginAlert');

    function showAlert(el, type, msg){
      el.className = 'alert show ' + type;
      el.textContent = msg;
    }

    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      loginAlert.className = 'alert';
      loginAlert.textContent = '';

      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value;

      if(!user || !pass){
        showAlert(loginAlert, 'error', 'Preencha usuário e senha.');
        return;
      }

      const cleanCPF = CPFUtils.cleanCPF(user);
      const isMaybeCPF = /^\d{11}$/.test(cleanCPF);

      if(isMaybeCPF && !CPFUtils.validateCPF(cleanCPF)){
        showAlert(loginAlert, 'error', 'CPF inválido. Confira os dígitos.');
        return;
      }

      const payload = {
        identifier: isMaybeCPF ? cleanCPF : user,
        by: isMaybeCPF ? 'cpf' : 'email',
        password: pass
      };

      try{
        loginBtn.disabled = true;
        loginBtn.textContent = 'Entrando...';
        const data = await API.apiPost('/api/auth/login', payload);
        if(data && data.token){
          localStorage.setItem('token', data.token);
        }
        if(data && data.name){
          localStorage.setItem('userName', data.name);
        }
        showAlert(loginAlert, 'success', 'Login realizado com sucesso.');
        window.location.href = 'dashboard.html';
      }catch(err){
        showAlert(loginAlert, 'error', err.message || 'Erro ao fazer login.');
      }finally{
        loginBtn.disabled = false;
        loginBtn.textContent = 'Entrar';
      }
    });
  </script>
</body>
</html>
